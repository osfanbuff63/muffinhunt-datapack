name: Publish release
on: 
  push:
    tags:
     - 'v*'
  workflow_dispatch:
jobs:
   create-release:
    name: Create release
    runs-on: ubuntu-latest
    steps:
     - name: Create release
       uses: ncipollo/release-action@v1.10.0
   upload-normal:
    name: Create non-optimized datapack
    runs-on: ubuntu-latest
    needs: create-release
    steps:
     - name: Clone repository
       uses: actions/checkout@v3
       with:
         fetch-depth: 0
     - name: Zip files
       uses: vimtor/action-zip@v1
       with:
         files: data/ pack.mcmeta pack.png
         dest: 'muffinhunt-datapack v1.6.0.zip'
     - name: Upload to release
       uses: ncipollo/release-action@v1.10.0
       with:
         tag: ${{ github.ref }}
         generateReleaseNotes: true
     - name: Upload artifact
       uses: actions/upload-artifact@v3
       with:
         path: muffinhunt-datapack v1.6.0.zip
   upload-optimized-datapack:
    name: Create and optimize datapack
    runs-on: ubuntu-latest
    needs: [create-release,upload-normal]
    steps:
     - name: Download normal pack
       uses: actions/download-artifact@v3
       with:
         name: muffinhunt-datapack v1.6.0.zip
         path: ./
     - name: Unzip file
       run: unzip muffinhunt-datapack v1.6.0.zip
     - name: Run PackSquash
       uses: ComunidadAylas/PackSquash-action@master
       with:
          path: ./
          token: ${{ secrets.GITHUB_TOKEN }}
          minify_json_files: true
          validate_pack_metadata_file: true
          allow_optifine_mod: true
          delete_bloat_json_keys: true
          artifact_name: 'optimized-muffinhunt-datapack v1.6.0.zip'
     - name: Download optimized pack
       uses: actions/download-artifact@v3
       with:
         name: optimized-muffinhunt-datapack v1.6.0.zip
         path: ./
     - name: Publish optimized datapack
       uses: svenstaro/upload-release-action@v2
       with: 
         repo_token: ${{ secrets.GITHUB_TOKEN }}
         tag: ${{ github.ref }}
         file: optimized-muffinhunt-datapack v1.6.0.zip
   fetch-muffinhunt-resourcepack:
    name: Fetch latest MuffinHunt resource pack changes
    runs-on: ubuntu-latest
    needs: create-release
    steps:
     - name: Clone muffinhunt resource pack
       uses: actions/checkout@v3
       with: 
        repository: osfanmuffin/muffinhunt-resourcepack
        path: /resourcepack/
        fetch-depth: 0
     - name: Zip files
       uses: vimtor/action-zip@v1
       with:
        files: /resourcepack/*
        dest: 'muffinhunt-resourcepack v1.0.0.zip'
     - name: Publish resource pack
       uses: svenstaro/upload-release-action@v2
       with: 
         repo_token: ${{ secrets.GITHUB_TOKEN }}
         tag: ${{ github.ref }}
         file: muffinhunt-resourcepack v1.0.0.zip
   optimize-muffinhunt-resourcepack:
    name: Fetch and optimize MuffinHunt resourcepack
    runs-on: ubuntu-latest
    needs: [create-release,fetch-muffinhunt-resourcepack]
    steps:
     - name: Download regular pack
       uses: actions/download-artifact@v3
       with:
         name: muffinhunt-resourcepack.zip
         path: ./resourcepack/
     - name: Unzip resource pack
       run: |
           cd resourcepack
           unzip muffinhunt-resourcepack.zip
     - name: Run PackSquash
       uses: ComunidadAylas/PackSquash-action@master
       with:
          path: ./resourcepack/
          token: ${{ secrets.GITHUB_TOKEN }}
          minify_json_files: true
          validate_pack_metadata_file: true
          allow_optifine_mod: true
          delete_bloat_json_keys: true
          artifact_name: 'optimized-muffinhunt-resourcepack v1.0.0.zip'
     - name: Download optimized pack
       uses: actions/download-artifact@v3
       with:
         name: optimized-muffinhunt-resourcepack v1.0.0.zip
         path: ./
     - name: Publish resource pack
       uses: svenstaro/upload-release-action@v2
       with: 
         repo_token: ${{ secrets.GITHUB_TOKEN }}
         tag: ${{ github.ref }}
         file: optimized-muffinhunt-resourcepack v1.0.0.zip
